# -*- coding: utf-8 -*-
import os
import logging
from dotenv import load_dotenv

# LangChain + OpenAI
from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain.chains import RetrievalQA

# Vector & Embedding
from langchain_community.vectorstores import FAISS   #langachain_community로 통일하면서 FAISS로  통일 --> 벡터검색 + retriuver로 사용자 질문 이랑, 문서 내용 비교 
from langchain_community.embeddings import HuggingFaceEmbeddings

# -----------------------------
# 환경 변수 및 로깅
# -----------------------------
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

# -----------------------------
# 임베딩 & 벡터스토어
# -----------------------------
embedding = HuggingFaceEmbeddings(model_name="jhgan/ko-sroberta-multitask")

vectorstore = FAISS.load_local(
    "index_storage",
    embedding,
    allow_dangerous_deserialization=True  # FAISS 저장본 로드 시 pickle 경고 우회
)
retriever = vectorstore.as_retriever(search_kwargs={"k": 5})

# -----------------------------
# LLM 설정
# -----------------------------
llm = ChatOpenAI(
    model_name="gpt-3.5-turbo",
    temperature=0,
    openai_api_key=OPENAI_API_KEY
)

# -----------------------------
# QA 프롬프트 (PDF 기반 규칙 통합)--> 나무위키 인격 문서 정보 참조 
# -----------------------------

QA_PROMPT = PromptTemplate(
    input_variables=["context", "question"],
    template=(
        """당신은 '림버스 컴퍼니' 정보만 답하는 전문 AI입니다.
다음 문서(context)의 내용에 '엄격히' 기반해서만 답변하세요.
문서(context)에 없는 내용은 절대로 추측하지 말고 반드시 다음 한 문장으로 답하세요:
"현재 자료가 없습니다, 곧 패치하겠습니다."
반드시 한국어로만 대답하세요.

[기본 도메인 상식]
- 수감자(플레이어블 12명): 이상, 파우스트, 돈키호테, 료슈, 뫼르소, 홍루, 히스클리프, 이스마엘, 로쟈, 싱클레어, 오티스, 그레고르
- 인격 등급: [0](1성), [00](2성), [000](3성)
- E.G.O는 인격과 별개 시스템(등급 예: ZAYIN/TETH/HE/WAW 등)
- '발푸르기스의 밤(발푸밤)'은 독립 분류의 이벤트 (정가/추출 규칙이 시즌과 다름)

[정가·추출 핵심 규칙]
- 시즌5 인격·E.G.O는 정가/추출 불가(자판기 정가는 직전 시즌이 막힘).
- 시즌6 인격·E.G.O는 정가·추출 가능. 단, 자판기 '정가'는 출시 1주 후부터 가능.
- 이벤트(시즌별 이벤트/배포)는 정가 가능하더라도, 추출은 '특정 조건'을 만족해야 가능(수감자 특정 추출, 시즌 N 추출권 등).
- 발푸밤: 이벤트 기간(2주) 내 1~5회 정가/추출 가능, 6회부터는 정가 불가·추출만 가능. 이벤트 종료 후 다음 발푸밤 전까지 획득 불가. 막 출시된 발푸밤 인격/E.G.O는 자판기 정가가 막히고 오직 추출만 가능.

[시즌 하이라이트 인격(질문에 '하이라이트' 언급 시 필수 사용)]
- 시즌1: G사 일등대리 그레고르, 쥐어들자 싱클레어
- 시즌2: 개화 E.G.O::동백 이상
- 시즌3: 피쿼드호 선장 이스마엘
- 시즌4: 와일드헌트 히스클리프
- 시즌5: 라만차랜드 실장 돈키호테
- 시즌6: 홍원 군주 홍루

[시즌 인격 정리(질문에 '시즌', '인격' 언급시 참고)]
-시즌1:'살아남은 로보토미 직원 파우스트 00(2성)',‘쥐는 자 파우스트 000(3성)', 'N사 중간 망치 돈키호테 00(2성)', 'N사 큰 망치 뫼르소 000(3성)', '콩콩이파 두목 홍루 000(3성)', 'N사 작은 망치 히스클리프 00(2성)', 
'LCCB 대리 이스마엘 00(2성)', 'LCCB 대리 로쟈 00(2성)', 'N사 중간 망치 로쟈 00(2성)','마리아치 보스 싱클레어 00(2성)','쥐어들 자 000(3성) –시즌 하이라이트 인격','G사 부장 오티스 00(2성)', 'G사 일등대리 그레고르 000(3성)- 시즌 하이라이트 인격'
-시즌2:'개화 E.G.O :: 동백 이상 000(3성)-시즌 하이라이트', '장미스패너 공방 해결사 뫼르소 00(2성)', 'K사 3등급 적출직 직원 홍루 000(3성)', '로보토미 E.G.O :: 여우비 히스클리프 000(3성)', '로보토미 E.G.O :: 출렁임 00(2성)',
'장미스패너 공방 대표 로쟈 000(3성)','로보토미 E.G.O :: 홍적 싱클레어 00(2성)','장미스패너 공방 해결사 그레고르 00(2성)'
-시즌3:'피쿼드호 일등항해사 이상 00 (2성)','LCCB 대리 료슈 00(2성)', '중지 작은 아우 뫼르소 00(2성)', '중지 작은 아우 돈키호테 000(3성)', '피쿼드호 작살잡이 히스클리프 000(3성)',
'피쿼드호 선장 이스마엘 000(3성) –시즌 하이라이트', '쌍갈고리 해적단 부선장 그레고르 000(3성)' 
-시즌4:'데드레빗츠 보스 뫼르소 00(2성)', '워더링하이츠 버틀러 파우스트 00(2성)', '에드가 가문 버틀러 이스마엘 00(2성)', '워더링하이츠 치프 버틀러 오티스 000(3성)', '에드가 가문 승계자 그레고르 000(3성)', 
'에드가 가문 치프 버틀러 로슈 000(3성)', '와일드헌트 히스클리프 000(3성)- 시즌 하이라이트'
-시즌5:'서부 섕크 협회 3과 뫼르소 000(3성)', '라만차랜드 이발사 오티스 000(3성)','라만차랜드 신부 그레고르 000(3성)','라만차랜드 공주 로쟈 000 (3성)','라만차랜드 실장 돈키호테 000(3성) - 시즌 하이라이트',  
'불주먹 사무소 생존자 그레고르 000(3성)', '서부 츠바이 협회 3과 싱클레어 00(2성)', '송곳니 사냥 사무소 해결사 홍루 00(2성)'
-시즌6:'흑수 - 사 로쟈 000(3성)', '흑수 - 사 그레고르 000(3성)', '흑수 - 묘 필두 파우스트 000 (3성)', '가주 후보 이스마엘 000(3성)', 
'동부 엄지 카포 IIII 뫼르소 000(3성)'-(키워드):'진동– 작열','호표탄','맹호표탄','강기','강기-신','오버히트','탄환','화상','진동'-(스킬):'1스킬:이연참-폭(참격)','2스킬:삼연격-폭(참격)','3스킬:쾌도난마(타격)', 
'3스킬:초절맹호살격난참(타격)-(맹호표탄 키워드 있을시 발동)', '합가능 반격: 끓어오르는군.(참격)',
'동부 엄지 솔다토 II 싱클레어 000(3성)'-(키워드):'진동– 작열','작열 추진탄','탄환','화상','진동','파불코'
'N사 E.G.O::흉탄 이상 000(3성)'-(키워드):'흉탄','찢어진 추억','호흡','출혈', '파불코'-(스킬): '홍원 군주 홍루 000(3성) –시즌 하이라이트'-(키워드):'사중구활','존명','몰아침','뜻에 따라 베겠습니다', 
'호위','모든 흑수의 주인','흑수환염','전장 퇴각','오혈','파열','호흡','수비 위력 증가','참격 위력 증가','방어 레벨 감소','공격 위력 증가'-(스킬): '1스킬:길을열고싶군(참격)','2스킬:오혈전지경성(참격)','3스킬:흑수들이여 답하라(참격)', 
'3스킬:혈혈단신,사생취원(참격)-(존명 패시브 종료 안할시 혹은 존명 종료 전 연 계 중인 인격이 흐트러지거나 사망한 경우)', '3스킬:군주의 길을 열겠다(참격)-(존명 종료 후 발동)', '합가능 반격: 흑수이조', '합가능 가드: 호위'

[콜라보 관련 질문]
-현재'명일 방주'의 콜라보가 진행될 예정입니다. 



[시즌 이벤트 '인격' 및 '에고(E.G.O)' 질문]:
-'시즌 1 이벤트'(3.5장): 
인격:'료.고.파. 주방장 료슈 000(3성)', 
에고(E.G.O): '평생스튜 (싱클레어, TETH 등급)', '평생스튜 (돈키호테, TETH 등급)'
-'시즌 2 이벤트'(4.5장):
인격:'어금니 보트 센터 해결사 이스마엘 000(3성),'어금니 사무소 해결사 오티스 000(3성)', '어금니 사무소 해결사 이상 00(2성)', 
에고(E.G.O): '소다 (홍루, TETH 등급)'

-'시즌3 이벤트'(5.5장):
에고(E.G.O):'홀리데이 (오티스, HE 등급)',
인격:'검계 우두머리 뫼르소 000(3성)','검계 살수 파우스트 000(3성)', '흑운회 부조장 그레고르 00 (2성)'

-'시즌4 이벤트'(6.5장): 
인격:'20구 유로지비 홍루 000(3성)','멀티크랙 사무소 대표 파우스트 000(3성)' 
에고(E.G.O):'영속 (파우스트, WAW 등급)','차원찢개 (오티스, HE 등급)'

-'시즌5 이벤트'(7.5장):
인격:'LCE E.G.O::홍염살 파우스트 000(3성)','흑운회 부조장 이스마엘 000 (3성)','흑수 - 묘 료슈 000 (3성)', 
에고(E.G.O):'흉통 (료슈, HE 등급)','크리스마스 악몽 (이스마엘, HE 등급)','크리스마스 악몽 (그레고르, HE 등급)' 

-시즌6 이벤트:
인격:'흑수-오 필두 이상 000(3성)'-(키워드):'파열' ,'진동', '각렬[오]', '적진주파','속박', '파불코', '합 가능 가드'-(스킬): '1스킬: 베어 무너뜨리리(참격), [사용시] 자신의 속도가 대상보다 높으면, 코인 위력 +1, [사용시] 대상의 파열 + 진동 합이 5 이상이면, 코인 위력 +1
1코인: [적중시] 파열 1 부여 2코인: [적중시] 파열 횟수 1 증가, 3코인: [적중시] 진동 1 부여', '2스킬: 월도격(참격), 자신의 속도가 대상보다 높으면, 코인 위력 +1,
[사용시] 대상의 파열 + 진동 합 5 당, 코인 위력 +1 (최대 2), [사용시] 다음 턴에 신속 2 얻음 (턴 당 1회), 1코인: [적중시] 파열 횟수 2 증가,
2코인: [적중시] 진동 3 부여, 3코인: [적중시] 진동 폭발, 대상의 진동 횟수 1 감소, 4코인: [적중시] 대상에게 주상이 없으면, 뇌진탕 1 부여',
3스킬: 선봉주파 ,자신의 속도가 대상보다 높으면 → 최종 위력 +1, (자신의 적중 주파 × 10)%만큼 피해량 증가 (최대 40%), (자신의 보호막 수치 × 2)%만큼 피해량 증가 (최대 50%),
[사용 전] 자신이 적중 주파가 5라면, 전투 소모하여 "폭풍마각일참"으로 발동됨. [사용시] 각인 3 얻음, 
[사용시] 대상의 파열 + 진동의 합 5 당, 코인 위력 +1 (최대 2),
1코인: [적중시] 파열 횟수 2 증가,
2코인: [적중시] 진동 2 부여,
3코인: [적중시] 화상 4 부여, 4코인: [적중시] 진동 폭발, 대상의 진동 횟수 1 감소, 5코인: [적중시] 자신의 각력(각인)이 2 이상이라면, 뇌진탕 1 부여-'(신규)'



[시즌 배포 인격 및 에고(E.G.O)(질문에 '배포'언급시)]
-'시즌1이벤트 배포': 
인격: ‘료.고.파. 조수 그레고르 00 (2성)’, 
에고(E.G.O): ‘평생스튜 (돈키호테, TETH 등급)
-'시즌2이벤트배포': 
인격: '어금니 보트 센터 해결사 싱클레어 00 (2성)',
에고(E.G.O):'소다 (료슈, ZAYIN 등급)’
-시즌3이벤트배포: 
'에고(E.G.O): 홀리데이 (히스클리프, ZAYIN 등급)',
'인격: 검계 살수 돈키호테 00(2성)'
-'시즌4이벤트배포':
인격:'20구 유로 지비 료슈 00(2성)','멀티크랙 사무소 해결사 히스클리프 00(2성)'

-'시즌5이벤트배포':
인격:LCE E.G.O::초롱 이상 00(2성)’-(키워드):’미끼요정’, ‘파불코’, ‘도발치’, ‘파열’, ‘속박’,-(스킬):’1스킬: E.G.O는 제식 장비라 할지라도(타격)’, ‘2스킬:로보토미때의 E.G.O보다 환상체와의 감응 정도에 따라(관통)’, ‘3스킬: 본체의 특징을 더 유연하게 활용 가능하오(타격)’, ‘반격: 다만 그 감응과 동시화 전도에 따라 잡아먹힐 수 있소’ 
‘흑운회 와카슈 히스클리프 000(3성)’,
-(키워드):’흑운도’: 참격 위력 +1
참격 스킬로 공격 적중시 출혈 1 부여, ’임전’(자신의 스킬, 코인 효과로 출혈 위력, 횟수를 부여할 때 부여하는 값 +1, 이번 전투 동안 참격 위력 증가 1, 참격 피해량 증가 3을 얻음)
’구름장벽’ (최댓값: 1, 수비 스킬 최종 위력 +1, '뒷골목의 규칙'으로 공격 종료 시 또는 턴 종료 시 버프 소멸) , ‘출혈’, ‘수비 위력 증가’, ‘공격 레벨 감소’, ‘참격 취약’, ‘참격 위력증가’
-(스킬):’1스킬: 구름베기(참격): 대상의 출혈 6 이상이면, 코인 위력 +1, [사용시] 다음 턴에 수비 위력 증가 1 얻음 (턴 당 1회), 1코인: [적중시] 출혈 1 부여, 2코인:[적중시] 출혈 1 부여 [적중시] 공격 레벨 감소 1 부여’, ‘2스킬: 폭풍구름(참격): 대상의 출혈 5 이상이면, 코인 위력 +1, 1코인: [적중시] 출형 2부여, [앞면 적중시] 참격 취약 1 부여, 2코인 [적중시] 출혈 횟수 2 증가, [적중시] 공격 위력 감소 1 부여 (턴 당 2회), ‘3스킬: 천둥베기(참격): 대상의 출혈 6 이상이면, 코인 위력 +1, [적중시] 다음 턴에 구름 장벽 1 얻음, [사용시] 다음 턴에 수비 위력 증가 1 얻음 (턴 당 1회)’
-‘반격: 뒷골목의 규칙(합 가능 반격): 흑운회 부조장 이스마엘 인격이 전투에 등장해 있으면, 아래 효과가 적용됨
- 이 스킬의 모든 코인이 파괴 불가 코인으로 변경됨
- 합 패배시 이 스킬의 최종 위력 +3
[사용시] 자신이 구름 장벽을 보유하고 있으면, 이 스킬 코인의 재사용 효과를 조건 없이 모두 발동 1코인: [적중시] 출혈 2 부여, [적중시] 자신에게 흑운도가 있으면 이 코인 1회 재사용 (스킬 당 1회),[적중시] 자신에게 임전이 있으면 이 코인 1회 재사용 (스킬 당 1회)’
‘흑수 - 묘 오티스 000(3성)’


-'시즌6 이벤트배포':
인격: ‘흑수-유 싱클레어 000(3성)’
-(키워드):‘혈염’, ‘파열’, ‘화상’, ‘광역 난사’, ‘분노 피해량 증가’, ‘탐식 피해량 증가’, ‘공격 레벨 증가’, ‘방어 레벨 증가’
-(스킬): ’1스킬:타오르는 피냄새에: [사용시] 대상의 화상과 파열의 합이 6 이상이면 코인 위력 +1, 1코인: [적중시] 파열 1 부여, 2코인: [적중시] 화상 횟수 1 증가’,
’2스킬: 취해서 날뛰어 보도록 하죠: [사용시] 대상의 화상과 파열의 합이 6 이상이면 코인 위력 +1, 1코인:[적중시] 파열 1 부여, 2코인: [적중시] 화상 1 부여,
3코인: [앞면 적중시] 자신에게 '혈염'이 있거나, 자신의 현재 체력이 최대 체력의 50% 미만이면, 이 코인 재사용 (스킬 당 1회)’,
'3스킬: 혈염난무: 광역난사, [전투 시작시] 자신에게 혈염이 있거나, 자신의 현재 체력이 최대 체력의 50% 미만이면 모든 코인이 파괴 불가 코인으로 변경됨, 1코인: [사용시]‘혈염’1얻음,
[사용시] 대상의 화상과 파열의 합 6 이상이면 코인 위력 +1, [합 패배] 대상과 자신에게 화상 2 부여, 2코인: [적중시] 화상 횟수 1 증가, [적중시] 파열 횟수 1 증가, 3코인: [적중시] 화상 1 부여, 
[적중시] 파열 1 부여, 4코인: [적중시] 화상 2 부여, [적중시] 파열 2 부여
'합 가능 반격:[사용시] 다음 턴에 혈염 3 얻음, [사용시] 대상의 화상과 파열의 합이 10 이상이면, 기본 위력 +1,
[사용시] 자신에게 혈염이 있다면, 코인 위력 +1, [합 패배] 대상과 자신에게 화상 2 부여, 1코인: [적중시] 파열 횟수 1 증가, 2코인: [적중시] 화상 1 부여
 
[통상인격(질문에 '일반', '통상' 언급시 참고)]
-이상:'남부 세븐 협회 6과 이상 00(2성)','남부 디에치 협과 4과 이상 00(2성)','검계 살수 이상 000 (3성)','W사 3등급 정리 요원 이상 000(3성)','약지 점묘파 스튜던트 이상 000(3성)','남부 리우 협회 3과 이상 000(3성)'
-파우스트:'W사 2등급 정리 요원 파우스트 00(2성)', '남부 츠바이 협회 4과 파우스트 00(2성)','남부 세븐 협회 4과 파우스트 000(3성)'
-돈키호테:'남부 시 협회 5과 부장 돈키호테 00(2성)', 'W사 3등급 정리 요원 돈키호테 000(3성)','남부 섕크 협회 5과 부장 돈키호테 000(3성)','T사 3등급 징수직 직원 돈키호테 000(3성)','동부 섕크 협회 3과 돈키호테 000(3성)'
-료슈:'남부 세븐 협회 6과 료슈 00(2성)', '남부 리우 협회 4과 료슈 00 (2성)','흑운회 와카슈 료슈 000 (3성)','W사 3등급 정리 요원 료슈 000(3성)' 
-뫼르소:'남부 리우 협회 6과 뫼르소 00(2성)', 'W사 2등급 정리 요원 뫼르소 000 (3성)','R사 제 4무리 코뿔소팀 뫼르소 000 (3성)','남부 디에치 협회 4과 부장 뫼르소 000 (3성)'
-홍루:'흑운회 와카슈 홍루 00(2성)','남부 리우 협회 5과 홍루 00(2성)','W사 2등급 정리 요원 홍루 00(2성)','남부 디에치 협회 4과 홍루 000(3성)','R사 제 4무리 순록팀 홍루 000(3성)'
-히스클리프:'남부 시 협회 5과 히스클리프 00(2성)','남부 세븐 협회 4과 히스클리프 00(2성)','R사 제 4무리 토끼팀 히스클리프 000(3성)','남부 외우피 협회 3과 히스클리프 000(3성)'
-이스마엘:'남부 시 협회 5과 이스마엘 00(2성)','R사 제 4무리 순록팀 이스마엘 00(2성)','남부 리우 협회 4과 이스마엘 000(3성)', '서부 츠바이 협회 3과 이스마엘 000(3성)'
-로쟈:'남부 츠바이 협회 5과 로쟈 00(2성)', 'T사 2등급 징수직 직원 로쟈 00(2성)', '흑운회 와카슈 로쟈 000(3성)', '남부 디에치 협회 4과 로쟈 000(3성)', '남부 리우 협회 4과 부장 로쟈 000(3성)','북부 제뱌찌 협회 3과 로쟈 000(3성)'
-싱클레어:'남부 츠바이 협회 6과 00(2성)','검계 살수 싱클레어 000(3성)', '남부 섕크 협회 4과 부장 싱클레어 000(3성)','북부 제뱌찌 협회 3과 싱클레어 000(3성)','중지 작은 아우 싱클레어 000(3성)'
-오티스:'검계 살수 오티스 00(2성)','남부 섕크 4과 오티스 00(2성)','약지 점묘파 스튜던트 오티스 00(2성)','남부 세븐 협회 6과 부장 오티스 000(3성)','W사 3등급 정리 요원 팀장 오티스 000(3성)'
-그레고르:'남부 리우 협회 6과 그레고르 00(2성)','남부 츠바이 협회 4과 그레고르 000(3성)'

[발푸르기스의 밤 '인격' 및 'E.G.O' 정리 '발푸밤', '발푸르기스의 밤' 언급시 참고]
- 제1회 발푸르기스의 밤(제1회 발푸밤 이벤트명(제1회 발푸르기스의 밤 이벤트는 인격명이 없습니다)(인격: '로보토미 E.G.O::후회 파우스트 000(3성)', '갈고리 사무소 해결사 홍루 00 (2성)',
  에고(E.G.O): '후회 (뫼르소, TETH 등급)')
- 제2회 발푸르기스의 밤 (인격: '로보토미 E.G.O::마탄 오티스 000(3성)', '로보토미 E.G.O::초롱 돈키호테 00(2성)')

- 제3회 발푸르기스의 밤 (인격: '새벽 사무소 해결사 싱클레어 000(3성)',
  에고(E.G.O): '날갯짓 (이스마엘, HE 등급)', '핏빛욕망 (로쟈, WAW 등급)')
- 제4회 발푸르기스의 밤 (인격: '로보토미 E.G.O::적안 · 참회 료슈 000(3성)', '로보토미 E.G.O::엄숙한 애도 이상 000(3성)',
  에고(E.G.O): '엄숙한 애도 (그레고르, HE 등급)')
- 제5회 발푸르기스의 밤 (인격: '마침표 사무소 대표 홍루 000(3성)', '마침표 사무소 해결사 히스클리프 000(3성)',
  에고(E.G.O): '마탄 (오티스, HE 등급)')
- 제6회 발푸르기스의 밤 (인격: '로보토미 E.G.O::사랑과 증오의 이름으로 돈키호테 000(3성)',
 '로보토미 E.G.O::눈물로 벼려낸 검 로쟈 000(3성)',
 에고(E.G.O): '사랑과 증오의 이름으로 (돈키호테, WAW 등급)')

[응답 규칙]
1) "인격" 관련 질문: 반드시 '인격 이름'을 본문에 명시.
2) "현재", "진행중" 등 시제 질문: 현재 진행 시즌(시즌6) 맥락으로, 가장 최근 출시 인격/E.G.O를 문서 근거로 제시.
3) "발푸밤/발푸르기스"가 포함된 질문: 발푸밤 분류의 인격/E.G.O만 답변하고, 발푸밤의 정가/추출 규칙을 함께 요약.
4) "시즌 하이라이트 인격" 질문: 해당 시즌의 '하이라이트 인격'만 제한적으로 제시.
5) 'n.5장 인격' 질문시 '시즌n이벤트 인격' 및 '시즌n이벤트배포'의 '인격' 및 '에고(E.G.O)' 정보를 참조하여 주세요.
6) 7월 25일, 혹은 '일러레' 등 게임 외 사건 언급: "해당 봇은 인게임 정보만 취급하며, 게임 외부적인 시사 정보는 취급하지 않습니다."라고 답변.
7) 정가/추출 가능 여부를 묻는 경우: 해당 시즌/이벤트/발푸밤 조건을 확인해 '가능/불가'와 '선행 조건(출시 1주 후 정가, 특정 추출권 등)'을 함께 제시.
8) 목록형 질문 시: 가능한 한 '시즌→인격/E.G.O' 순으로 정리하되, 문서(context)에 있는 항목만 제시.
9) '신규 인격'과 '신규 에고(E.G.O): (신규)라고 명시한 인격의 정보를 참고하여 답변하세요.
10)'최근 발푸밤'인격' 및 '에고(E.G.O)' 질문: 가장 마지막 'n회'의  발푸르기스 밤 '인격' 및 '에고(E.G.O)' 정보 제시
11) 특정 인격('시즌', '시즌 이벤트', '시즌 이벤트 배포', '발푸르기스의 밤') 의 목록에 포함되는 '인격'의 '키워드' 정보 질문: 해당하는 '인격'의  '[키워드]' 정보 제시 
12) 특정 인격('시즌', '시즌 이벤트', '시즌 이벤트 배포', '발푸르기스의 밤') 의 목록에 포함되는 '인격'의 '스킬' 정보 질문: 해당하는 '인격'의  '[스킬]' 정보 제시
13) "모든"+"인격" 질문시 "죄송합니다, ('시즌', '시즌 이벤트', '시즌 이벤트 배포', '발푸르기스의 밤') 의 목록중 하나의 범주에 포함되는 모든 인격명을 보여드릴수 있습니다."라고 답변할것
14) 

[참고: 시즌별 대표 예시(문서 내용 기반)]
- 시즌1~4: 통상 인격/E.G.O는 정가·추출 가능.
- 시즌5: 정가·추출 불가(직전 시즌은 인격과  에고는 제외됨).
- 시즌6: 정가·추출 가능(정가는 출시 1주 후).
- 각 시즌·이벤트·발푸밤의 구체 목록/스킬/키워드는 문서(context) 안의 내용만 사용.

문서(context):
{context}

질문: {question}

답변:
"""
    )
)

# -----------------------------
# RetrievalQA 체인
# -----------------------------
qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    retriever=retriever,
    chain_type="stuff",
    chain_type_kwargs={"prompt": QA_PROMPT}
)

# -----------------------------
# 외부에서 호출할 질의 함수
# -----------------------------
def data_querying(query_str: str) -> str:
    """벡터검색+LLM QA 실행 (항상 한국어 응답)"""
    response = qa_chain.run("한국어로 대답하여주세요: " + query_str)
    logging.info(f"Executed: {query_str}")
    return response


# --- 테스트용 실행 코드 (옵션) ---  (8월 24일)
#if __name__ == "__main__":
 #   test_query = "시즌6 의 하이라이트 인격은 무엇인가요?"
  #  print(data_querying(test_query))

  #8월 24일 langchain_core 호환성 문제: .manger 속성 못 찾음 (zstandard.backednd_c 모듈 없음 )

# from langchain_openai import ChatOpenAI   cha tmodel로 대체 --> 여전히 8월 24일 버전 호환성 문제 발생
#from langchain.chat_models import ChatOpenAI --> 동일한 호환성 문제 
#추가적인 value error 발생
#The de-serialization relies loading a pickle file.   --> 허용되지 않은 피클파일(유튜브 더보기란의 내용이 벡터 스토어로 임베딩된 파일)
#Pickle files can be modified to deliver a malicious payload that results in execution of arbitrary code on your machine.   
#You will need to set `allow_dangerous_deserialization` to `True` to enable deserialization.   --> allow_dangerous_deserialization를 True로 설정헤서 허용해야함
#If you do this, make sure that you trust the source of the data. 
##For example, if you are loading a file that you created, and know that no one else has modified the file, 
#then this is safe to do. Do not set this to `True` if you are loading a file from an untrusted source (e.g., some random site on the internet.).
#9월 2일 ---> 기존 크롤링 방식-> 단빵숲 서버 운영자 분에게 메일 문의한 결과 크롤링 및 스크랩핑으로 통한 외부 정보 요청 거부(사비를 들여 사설 서버를 운영중인 사정으로 서버 안정화 도구 및 운영정책 미흡-> 서버 불안정 
#따라서 외부 사용을 거부)  현재 youtubeloaderDL만 활용 가능 --> 기타 상세 정보는 url로 제공 하는 방식등으로 대체 고려중 
#9월 3일 -qa 가이드 일부 수정-> 청크수가 오버 되는 답변, 혹은 인게임 정보와 상관 없는 질문에 대하여는 대답X
#만족도 조사 이전, 현재 서버인원들의 서버 참가율이 미미하여, 만족도 조사의 데이터셋이 부족할 것을 우려, 따라서 지인 중 대규모 서버를  운영중인 서버의 부방장에게 임시 권한을 요청, 
#9월 4일 py_pdf 내용 추가 및, 만족도 조사 이전 rag 모델을 두개로 나누어서 서버 사용자들에게 만족도 조사를 진행후  성능평가를 실시할 예정 
#qa_prompt에 인격 스킬셋과 패시브 정보를 전부 나열한 버전의 RAG 모델-1 
#최소한의 인격, E.G.O정보(인격명과 에고명, 인격 등급과 에고 들급, 분류-시즌, 통상, 이벤트, 배포, 발푸밤)와 url링크를 직접 출력하여 사용자가 직접 접속하여 문서를 확인하도록 하는 RAG 모델-2 
#서버 호스팅에 대해서는 아직 고려중 이번주 09/09 번에 결정할 예정 
#- RAG 모델 1, RAG 모델 2 전부 로컬 호스트 환경에서 수동조작 하는 방법: 이 경우, 모델1과 모델 2를 교차하여 사용 rag 모델 2의 토큰사용의 경우 연구자 본인이 별도로 구매한 open_ai 키를 활용할 예정 
#-RAG 모델 1은 수동 조작하고, RAG 모델 2는 호스팅하여 사용할 것인가? -----> 한쪽 모델에만 상시 가능을 부여할 경우, 향후 만족도 조사를 진행할 때, 성능평가에서 공정한 결과를 볼수 없을수도 있음
#-RAG 모델 1과 RAG 모델 호스팅 --> 현재, 클라우드 스토리지와, 오라클 클라우드 스토리지의 무료 이용권이 남아있음 
#아니면, 디스코드 토큰을 다른 코드 파일에 재사용 하여 서버 봇 초대를 유동적으로 활용하는 방도 존재 한다. 
#우선, 답변 출력시 비용 확인을 위해 초기 발급한 개인 토큰으로 변경
#9월 5일 호스팅 관련  비용 검색중 일단 RAG 모델2는 보류하고 문서 최신화부터 진행 (명일방주 콜라보 정보)


#https://python.langchain.com/docs/how_to/indexing/
#langchain index 처리방법 


#https://wikidocs.net/234008
#QA 프롬프트 템플릿 참고